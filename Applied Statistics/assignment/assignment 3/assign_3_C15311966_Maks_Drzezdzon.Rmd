---
title: "Assigment 3 Linear and Logistic Regression Models - C15311966 Maks Drzezdzon"
output: html_notebook
---



```{r - setup, load data (Submission deadline: 1.00pm 14th March 2022) }
library(pastecs) #For creating descriptive statistic summaries
library(ggplot2) #For creating histograms with more detail than plot
library(psych) # Some useful descriptive functions
library(semTools) #For skewness and kurtosis
library(FSA) # For percentage
library(car) # For Levene's test for homogeneity of variance 
library(effectsize) # To calculate effect size for t-test
library(kableExtra) # Used to generate report ready tables
library(tidyverse) # data wrangling 
library(gtsummary) # generate table for model results 
library(multcomp) # needed for glht 
library(emmeans)
require(ggiraph) # to use ggPredict
require(ggiraphExtra) # to use ggPredict
require(plyr)
library(plotly) # density plot
library(gridExtra)
library(PCAmixdata)


# Different subsets of data for experiments if time allows for it
untouched_dataset = read.csv("telecoms_churn.csv")
full_customer_dataset = subset(untouched_dataset, select = -c(X))
customer_dataset_user_has_internet = full_customer_dataset[which(full_customer_dataset$internetservice != 'No'), ]
customer_dataset_user_no_internet = full_customer_dataset[which(full_customer_dataset$internetservice == 'No'), ]


# $logcells = round(data$logcells, digit=5)


anovatab =
  function(mod){
    tab=as.matrix(anova(mod))
    rows=dim(tab)[1]
    moddf=sum(tab[,1])-tab[rows,1]
    ssmodel=sum(tab[,2])-tab[rows,2]
    msmodel=ssmodel/moddf
    f=msmodel/tab[rows,3]
    p=1-pf(f,moddf,tab[rows,1])
    tab2=tab[(rows-1):rows,]
    tab2[1,1:5]=c(moddf,ssmodel,msmodel,f,p)
    tab2=rbind(tab2,c(moddf+tab2[2,1],ssmodel+tab2[2,2],rep(NA,3)))
    rownames(tab2)=c('Model','Error','Total')
    colnames(tab2)[1]='df'
    return(print(tab2,na.print = "" , quote = FALSE,digits=3))
  }

get_var_name = function(var) {
  # get the literal name of the variable 
  deparse(substitute(var))
}


get_plots = function(df, df_name, columns_to_assess, target){
  # @df => what df will be plotted 
  # @df_name => name of df
  # @columns_to_assess = which cols do you want to graph
  # @target = your y value
  
  for (col in columns_to_assess){
      bar_plot = ggplot(df, aes_string(x=col,
                                  y=target, 
                                  show.legend = T)) + 
                  geom_bar(stat="identity") + 
                  ggtitle(paste0("Effect of ", aes_string(x=col), " on customer churn for ", df_name)) + 
                  theme(plot.title = element_text(hjust = 0.5))
      print(bar_plot)
      
  }
  
  
  # https://stats.stackexchange.com/questions/351781/how-to-plot-binary-presence-absence-1-0-data-against-continuous-variables
  conditional_density_plot = ggplot(df, aes(x=monthlycharges, fill=factor(churn))) + 
           geom_density(position = "stack") + 
           xlab("monthlycharges") + labs(fill='churn') +
           ggtitle(paste0("Effect of ~monthlycharges on customer churn for ", df_name)) + 
           theme(legend.text=element_text(size=12), 
                 axis.title=element_text(size=14),
                 plot.title = element_text(size=11))

  
  return(conditional_density_plot)
  
  
}


combine_dfs_freq_table = function(columns, df){
  # hard coded data set full_customer_dataset
  # @columns => what columns will be present in the frequency table  
  df_list = list()
  i=1
  for (col in cols){
    tmp_df = data.frame(round(prop.table(table(df[[col]])) * 100, 2))
    colnames(tmp_df)[1] = "Values"
    tmp_df['Column Name'] = col
    df_list[[i]] = tmp_df
    i=i+1
  }
  final_df = do.call(rbind, df_list)
  colnames(final_df)[2] = "% Representation of Column"
  final_df = final_df %>% relocate('Column Name', .before = "Values")
  return(final_df)
}


```



```{r - 1) Get Descriptive Statistics (Submission deadline: 1.00pm 14th March 2022)}
"
Using an R programme read these data into a data.frame and obtain basic descriptive
statistics/plots of the data. Present salient features from this exploratory data analysis
in your report.
"

# https://www2.nau.edu/lrm22/lessons/graph_tips/graph_tips.html#:~:text=The%20independent%20variable%20belongs%20on,%2Daxis%20(vertical%20line).


has_0 = full_customer_dataset[which(full_customer_dataset$churn == '0'), ]
has_1 = full_customer_dataset[which(full_customer_dataset$churn == '1'), ]

cols_list = colnames(full_customer_dataset)
cols = cols_list[cols_list != "churn" & cols_list != "customerid" & cols_list != "monthlycharges"]

get_plots(full_customer_dataset, get_var_name(full_customer_dataset), cols, "churn")
get_plots(customer_dataset_user_has_internet, get_var_name(customer_dataset_user_has_internet), cols, "churn")
get_plots(customer_dataset_user_no_internet, get_var_name(customer_dataset_user_no_internet), cols, "churn")




```


```{r - generate CI and df tables for temp}

df = full_customer_dataset
kbl(df) %>%
 kable_classic(full_width = F)

cols_list = colnames(df)
cols = cols_list[cols_list != "customerid" & cols_list != "monthlycharges"]
df = subset(df, select=c(cols))
data=df
table_df = combine_dfs_freq_table(cols, df)
kbl(table_df) %>%
 kable_classic(full_width = F)

df = customer_dataset_user_has_internet
cols_list = colnames(df)
cols = cols_list[cols_list != "customerid" & cols_list != "monthlycharges"]
df = subset(df, select=c(cols))
table_df = combine_dfs_freq_table(cols, df)
kbl(table_df) %>%
 kable_classic(full_width = F)

df = customer_dataset_user_no_internet
cols_list = colnames(df)
cols = cols_list[cols_list != "customerid" & cols_list != "monthlycharges"]
df = subset(df, select=c(cols))
table_df = combine_dfs_freq_table(cols, df)
kbl(table_df) %>%
 kable_classic(full_width = F)

```


```{r - 2) create models (Submission deadline: 1.00pm 14th March 2022)}
"
Using an R programme, analyse these data considering the two predictors, i.e. time
(continuous) and day (categorical) and the response logcells. You should consider the
possibility of interactions between the predictors. Submit your complete R programme
code with suitable explanatory in-code comments.
"

glm1 = glm(churn ~ (.)^2, data = data)
anovatab(glm1)
plot(glm1)
drop1(glm1, test='F')
summary(glm1)
vcov(glm1)
confint(glm1)

emmeans(glm1, )


# (.)^2 maps an interaction between all variables such as x1:x2 + x1:x3 + x2:x3... etc etc 
m1 = lm(churn ~ (.)^2, data = data)
m1
# https://www.statology.org/diagnostic-plots-in-r/

# is there a difference in means?
anovatab(m1)
plot(m1)

# ggPredict(m1, interactive=TRUE)

# show with interval plot
# done
# compare the group means

drop1(m1,test='F')

# assess model
summary(m1)
vcov(m1)
confint(m1)

emmeans(m1, ~additive*temperature)

emmeans(m1, pairwise~additive)
emmeans(m1, pairwise~temperature)


lsmeans(m1, ~additive:temperature, adjust="fdr")

emmip(m1, additive ~ temperature) + theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16, face="bold"))


glht_temperature = glht(m1, mcp("factor(temperature)" = "Tukey", interaction_average=TRUE))
summary(glht_temperature)

glht_additive = glht(m1, mcp("factor(additive)" = "Tukey", interaction_average=TRUE))
summary(glht_additive)


m1 %>% tbl_regression() # https://www.danieldsjoberg.com/gtsummary/articles/tbl_regression.html


```


```{r - 3) Write report (Submission deadline: 1.00pm 14th March 2022)}
"
Report your fndings (4 pages maximum excluding R-code): summarise the relationship
between predictor(s) and the response


(what are the average effects, confdence intervals,
results of tests of hypotheses etc.). Present plots where appropriate.
"

confint(m1,level=0.95)
confint(m2,level=0.95)

anovatab(m1)
anovatab(m2)

# https://support.minitab.com/en-us/minitab-express/1/help-and-how-to/modeling-statistics/anova/how-to/one-way-anova/interpret-the-results/key-results/
# https://support.minitab.com/en-us/minitab-express/1/help-and-how-to/modeling-statistics/regression/how-to/multiple-regression/before-you-start/overview/
# https://support.minitab.com/en-us/minitab-express/1/help-and-how-to/modeling-statistics/regression/how-to/simple-regression/before-you-start/overview/
# https://support.minitab.com/en-us/minitab-express/1/help-and-how-to/modeling-statistics/regression/how-to/covariance/overview/


```